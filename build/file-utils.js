"use strict";var FS=require("fs"),PATH=require("path"),UTIL=require("util"),CRYPTO=require("crypto"),SLASH=PATH.normalize("/"),File=function(a){var b=process.mainModule.filename,c=b.substring(0,b.lastIndexOf(SLASH)),d=PATH.relative(process.cwd(),c),e=null,f=null,g=!1;if(a){a=PATH.normalize(a);g=a[0]===SLASH||a.indexOf(":")!==-1;a==="."+SLASH?a="":a===".."+SLASH&&(a="..");e=a;f=g?a:PATH.join(d,a)}var h=this;Object.defineProperties(this,{_isAbsolute:{value:g},_relative:{value:d},_path:{value:e},_relativePath:{value:f},_removeOnExit:{value:!1,writable:!0},_removeOnExitCallback:{value:function(){removeSynchronous(h)}}})},checkPermission=function(a,b,c){FS.stat(a,function(a,d){a?c(a,!1):c(null,!!(b&parseInt((d.mode&parseInt("777",8)).toString(8)[0])))})},setPermission=function(a,b,c,d){FS.stat(a,function(e,f){if(e)d&&d(e,!1);else{var g=(f.mode&parseInt("777",8)).toString(8),h=parseInt(g[0]),i=!!(h&b);if(i&&!c||!i&&c){var j=c?b:-b;FS.chmod(a,j+h+g.substring(1),function(a){d&&d(a,!a)})}else d&&d(null,!1)}})};File.prototype.canExecute=function(a){if(!a)return;if(!this._path)return a(null,!1);checkPermission(this._relativePath,1,a)};File.prototype.canRead=function(a){if(!a)return;if(!this._path)return a(null,!1);checkPermission(this._relativePath,4,a)};File.prototype.canWrite=function(a){if(!a)return;if(!this._path)return a(null,!1);checkPermission(this._relativePath,2,a)};File.prototype.checksum=function(a,b,c){if(arguments.length===2&&typeof b=="function"){c=b;b="hex"}if(!c)return;if(!this._path)return c(null,null);var d=this;FS.stat(this._relativePath,function(e,f){if(e)c(e,null);else if(f.isDirectory())c("The abstract path is a directory.",null);else if(f.isFile()){a=CRYPTO.createHash(a);var g=FS.ReadStream(d._relativePath);g.on("error",function(a){c(a,null)});g.on("data",function(b){a.update(b)});g.on("end",function(){c(null,a.digest(b))})}})};File.prototype.contains=function(a,b){this.search(a,function(a,c){a?b(a,!1):b(null,c.length!==0)})};File.prototype.copy=function(a,b,c){var d=arguments.length;if(d===1)b=!1;else if(d===2&&typeof b=="function"){c=b;b=!1}if(!this._path){c&&c(null,!1);return}var e=a instanceof File?a._isAbsolute:(new File(a))._isAbsolute,g=PATH.normalize(a.toString()),h=e?g:PATH.join(this._relative,g),i=this,j=function(){var a=FS.createWriteStream(h);a.on("error",function(a){c&&c(a,!1)});a.once("open",function(a){UTIL.pump(FS.createReadStream(i._relativePath),f,function(a){a=a===undefined?null:a;c&&c(a,!a)})})},k=function(){FS.mkdir(h,function(a){a?c&&c(a,!1):FS.readdir(i._relativePath,function(a,b){if(a)c&&c(a,!1);else{var d=b.length,e=0;b.forEach(function(a){(new File(PATH.join(i._path,a))).copy(PATH.join(g,a),function(a,b){if(a)c&&c(a,!1);else{e++;e===d&&c&&c(null,!0)}})})}})})};FS.stat(this._relativePath,function(a,d){a?c&&c(a,!1):PATH.exists(h,function(a){a&&!b?c&&c(null,!1):d.isFile()?j():d.isDirectory()&&(a&&b?(new File(g)).remove(function(a,b){a?c&&c(a,!1):k()}):k())})})};File.prototype.createDirectory=function(a){if(!this._path){a&&a(null,!1);return}var b=function(a,c){a.exists(function(d){if(d)return c(null,!1);a.mkdir(function(d,e){if(e)return c(null,!0);var f=a.getParentFile();if(f===null)return c(null,!1);b(f,function(b,d){d?a.mkdir(function(a,b){c(a,b)}):f.exists(function(b){if(!b)return c(null,!1);a.mkdir(function(a,b){c(a,b)})})})})})};b(this.getAbsoluteFile(),function(b,c){a&&a(b,c)})};File.prototype.createNewFile=function(a){if(!this._path){a&&a(null,!1);return}var b=this._relativePath;PATH.exists(b,function(c){if(c)a&&a(null,!1);else{var d=FS.createWriteStream(b);d.on("error",function(b){a&&a(b,!1)});d.end();a&&a(null,!0)}})};File.createTempFile=function(a,b){arguments.length===1&&typeof a=="function"&&(b=a);var c="",d="",e=".";if(a){c=a.prefix?a.prefix:c;d=a.suffix?a.suffix:d;e=a.directory?a.directory.toString():e}var f=Math.floor(Math.random()*1e12),g=new File(PATH.join(e,c+f+d));PATH.exists(g._relativePath,function(c){if(c)File.createTempFile(a,b);else{g.removeOnExit();var d=FS.createWriteStream(g._relativePath);d.on("error",function(a){b&&b(a,null)});d.end();b&&b(null,g)}})};File.prototype.equals=function(a){var b=a instanceof File?a.getAbsolutePath():(new File(a)).getAbsolutePath();return b===this.getAbsolutePath()};File.prototype.exists=function(a){if(!a)return;if(!this._path)return a(!1);PATH.exists(this._relativePath,function(b){a(b)})};File.prototype.getAbsoluteFile=function(){return new File(this.getAbsolutePath())};File.prototype.getAbsolutePath=function(){return this._path?this._isAbsolute?this._path:PATH.join((new File(process.mainModule.filename)).getParent(),this._path):null};File.prototype.getName=function(){return this._path?PATH.basename(this._path):null};File.prototype.getParent=function(){if(!this._path)return null;var a=this._path.lastIndexOf(SLASH);return a===-1?null:a===0?this._path===SLASH?null:"/":this._path.substring(0,a)};File.prototype.getParentFile=function(){var a=this.getParent();return a===null?null:new File(a)};File.prototype.getPath=function(){return this._relativePath};File.prototype.getPermissions=function(a){if(!a)return;if(!this._path)return a(null,!1);FS.stat(this._relativePath,function(b,c){b?a(b,!1):a(null,(c.mode&parseInt("777",8)).toString(8))})};File.prototype.isDirectory=function(a){if(!a)return;if(!this._path)return a(null,!1);FS.stat(this._relativePath,function(b,c){b?a(b,!1):a(null,c.isDirectory())})};File.prototype.isFile=function(a){if(!a)return;if(!this._path)return a(null,!1);FS.stat(this._relativePath,function(b,c){b?a(b,!1):a(null,c.isFile())})};File.prototype.isHidden=function(){throw"Not yet implemented."};File.prototype.lastModified=function(a){if(!a)return;if(!this._path)return a("Null path.");FS.stat(this._relativePath,function(b,c){b?a(b):a(null,c.mtime)})};File.prototype.list=function(a,b){var c=arguments.length;if(c===0)return;if(c===1&&typeof a=="function"){b=a;a=null}if(!b)return;if(!this._path)return null,null;var d=this;FS.stat(this._relativePath,function(c,e){if(c)b(c,null);else if(e.isFile())b("The path is not a directory.",null);else if(e.isDirectory()){var f=function(a,b,c,d,e){var g=function(a){var c=[],e;a.forEach(function(a){d(a,PATH.join(b,a))&&c.push(a)});return c};FS.readdir(a,function(h,i){if(h)return e(h,null);d&&(i=g(i));var j=i.length,k=0,l=function(){if(k===j){e(null,c);return!0}return!1};if(l())return;i.forEach(function(g){var h=PATH.join(b,g);FS.stat(PATH.join(a,g),function(b,i){if(b)return e(b,null);if(i.isFile()){c[g]=h;k++;l()}else if(i.isDirectory()){c[g]={};f(PATH.join(a,g),h,c[g],d,function(a,b){if(a)return e(a,null);k++;l()})}})})})};f(d._relativePath,d._path,{},a,function(a,c){b(a,c)})}})};File.prototype.listFiles=function(a,b){var c=arguments.length;if(c===0)return;if(c===1&&typeof a=="function"){b=a;a=null}if(!b)return;var d=function(a){for(var b in a){var c=a[b];typeof c=="string"?a[b]=new File(c):d(c)}};this.list(a,function(a,c){if(a)b(a,null);else{d(c);b(null,c)}})};File.prototype.rename=function(a,b,c){var d=arguments.length;if(d===1)b=!1;else if(d===2&&typeof b=="function"){c=b;b=!1}if(!this._path){c&&c(null,!1);return}var e=a instanceof File?a._isAbsolute:(new File(a))._isAbsolute,f=PATH.normalize(a.toString()),g=e?f:PATH.join(this._relative,f);if(b)FS.rename(this._relativePath,g,function(a){c&&c(a,!a)});else{var h=this;PATH.exists(g,function(a){a?c&&c(null,!1):FS.rename(h._relativePath,g,function(a){c&&c(a,!a)})})}};File.prototype.remove=function(a){if(!this._path){a&&a(null,!1);return}var b=this;FS.stat(this._relativePath,function(c,d){if(c){a&&a(c,!1);return}d.isFile()?FS.unlink(b._relativePath,function(b){a&&(b?a(b,!1):a(null,!0))}):d.isDirectory()&&FS.readdir(b._relativePath,function(c,d){if(c){a&&a(c,!1);return}var e=d.length,f=0,g=function(){if(e===f){FS.rmdir(b._relativePath,function(b){a&&(b?a(b,!1):a(null,!0))});return!0}return!1};if(!g())for(var h in d)(new File(PATH.join(b._path,d[h]))).remove(function(b,c){if(b)a&&a(b,!1);else{f++;g()}})})})};var removeSynchronous=function(a){if(!a._path)return!1;if(!PATH.existsSync(a._relativePath))return!1;var b=FS.statSync(a._relativePath);if(b.isFile())FS.unlinkSync(a._relativePath);else if(b.isDirectory()){var c=FS.readdirSync(a._relativePath);for(var d in c)removeSynchronous(new File(PATH.join(a._path,c[d])));FS.rmdirSync(a._relativePath)}return!0};File.prototype.removeOnExit=function(a){a=a!==undefined?a:!0;if(!this._removeOnExit&&a){this._removeOnExit=a;process.on("exit",this._removeOnExitCallback)}else if(this._removeOnExit&&!a){this._removeOnExit=a;process.removeListener("exit",this._removeOnExitCallback)}};File.prototype.search=function(a,b){if(!b)return;if(!this._path)return b(null,!1);a=a instanceof File?a.getName():a;var c=[];this.list(function(b,d){b===a&&c.push(d);return!0},function(a){a?b(a,null):b(null,c)})};File.prototype.setExecutable=function(a,b){if(!this._path)return b(null,!1);setPermission(this._relativePath,1,a,b)};File.prototype.setPermissions=function(a,b){if(!this._path)return b(null,!1);FS.chmod(this._relativePath,a,function(a){b&&b(a,!a)})};File.prototype.setReadable=function(a,b){if(!this._path)return b(null,!1);setPermission(this._relativePath,4,a,b)};File.prototype.setReadOnly=function(a){FS.chmod(this._relativePath,"444",function(b){a(b,!b)})};File.prototype.setWritable=function(a,b){if(!this._path)return b(null,!1);setPermission(this._relativePath,2,a,b)};File.prototype.size=function(a){if(!a)return;if(!this._path)return a("Null path.",null);FS.stat(this._relativePath,function(b,c){b?a(b,null):a(null,c.size)})};File.prototype.toString=function(){return this._relativePath};module.exports.File=File;